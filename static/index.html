<!DOCTYPE html>
<html>
<head>
  <title>RL Car Simulation</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* Darkâ€‘mode styles */
    body.dark {
      background: #1e1e1e;
      color: #f5f5f5;
    }
    body.dark label,
    body.dark output {
      color: #f5f5f5;
    }
    body.dark #plot {
      background: #333333;
    }

    /* Layout */
    #app {
      display: flex;
      align-items: flex-start;
      padding: 20px;
      box-sizing: border-box;
    }
    #controls {
      width: 300px;
      padding: 1rem;
      box-sizing: border-box;
    }
    #plot {
      width: 700px;
      height: 450px;
      margin-left: 20px;
      background: transparent;
    }

    /* Original styles */
    label { display: block; margin-top: 10px; }
    output { margin-left: 10px; font-weight: bold; }
    #themeToggle {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #controls button {
      margin-top: 15px;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <button id="themeToggle">ðŸŒ™ Dark Mode</button>
  <div id="app">
    <div id="controls">
      <h2>Car Simulator</h2>

      <label>Friction:
        <input type="range" id="friction" min="0" max="1.0" step="0.01" value="0.7" oninput="fDisplay.value = friction.value">
        <output id="fDisplay">0.7</output>
      </label>

      <label>Gas Sensitivity:
        <input type="range" id="gas_sensitivity" min="0" max="2.0" step="0.01" value="0.9" oninput="gDisplay.value = gas_sensitivity.value">
        <output id="gDisplay">0.9</output>
      </label>

      <label>Brake Sensitivity:
        <input type="range" id="brake_sensitivity" min="0" max="2.0" step="0.01" value="0.4" oninput="bDisplay.value = brake_sensitivity.value">
        <output id="bDisplay">0.4</output>
      </label>

      <label>Steer Sensitivity:
        <input type="range" id="steer_sensitivity" min="0" max="0.5" step="0.01" value="0.1" oninput="sDisplay.value = steer_sensitivity.value">
        <output id="sDisplay">0.1</output>
      </label>

      <label>Path Type:
        <select id="path_type">
          <option value="sine">Sine</option>
          <option value="straight">Straight</option>
        </select>
      </label>

      <button onclick="simulate()">Simulate</button>
      <button id="resetBtn">Reset to Defaults</button>
    </div>

    <div id="plot"></div>
  </div>

  <script>
    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      themeToggle.textContent = document.body.classList.contains('dark')
        ? 'â˜€ï¸ Light Mode'
        : 'ðŸŒ™ Dark Mode';
    });

    let animationInterval = null;

    async function simulate() {
      if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
      }

      const friction        = parseFloat(document.getElementById("friction").value);
      const gas_sensitivity = parseFloat(document.getElementById("gas_sensitivity").value);
      const brake_sensitivity = parseFloat(document.getElementById("brake_sensitivity").value);
      const steer_sensitivity = parseFloat(document.getElementById("steer_sensitivity").value);
      const path_type       = document.getElementById("path_type").value;

      const res = await fetch("/simulate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          friction,
          gas_sensitivity,
          brake_sensitivity,
          steer_sensitivity,
          path_type
        })
      });
      const data = await res.json();
      const path = data.path;
      const car  = data.car;
      const waypoints = data.waypoints || [];

      // Initialize traces
      const plotData = [
        {
          x: [], y: [],
          mode: 'lines',
          name: 'Path',
          line: { dash: 'dot', width: 2, color: 'gray' }
        },
        {
          x: [], y: [],
          mode: 'lines+markers',
          name: 'Car',
          line: { color: 'blue', width: 2 },
          marker: { size: 6 }
        },
        {
          x: waypoints.map(p => p[0]),
          y: waypoints.map(p => p[1]),
          mode: 'markers',
          name: 'Waypoints',
          marker: { color: 'red', size: 10, symbol: 'cross' }
        }
      ];

      Plotly.newPlot('plot', plotData, {
        margin: { t: 20, b: 40, l: 40, r: 20 },
        xaxis: { title: "X" },
        yaxis: { title: "Y", scaleanchor: "x" }
      });

      let idx    = 0;
      const maxIdx = Math.max(path.length, car.length);
      animationInterval = setInterval(() => {
        if (idx >= maxIdx) {
          clearInterval(animationInterval);
          animationInterval = null;
          return;
        }
        if (idx < path.length) {
          Plotly.extendTraces('plot', {
            x: [[path[idx][0]]],
            y: [[path[idx][1]]]
          }, [0]);
        }
        if (idx < car.length) {
          Plotly.extendTraces('plot', {
            x: [[car[idx][0]]],
            y: [[car[idx][1]]]
          }, [1]);
        }
        idx++;
      }, 50);

      // Reset handler
      document.getElementById("resetBtn").onclick = () => {
        document.getElementById("friction").value = 0.7;        fDisplay.value = 0.7;
        document.getElementById("gas_sensitivity").value = 0.9; gDisplay.value = 0.9;
        document.getElementById("brake_sensitivity").value = 0.4; bDisplay.value = 0.4;
        document.getElementById("steer_sensitivity").value = 0.1; sDisplay.value = 0.1;
        document.getElementById("path_type").value = "sine";
      };
    }
  </script>
</body>
</html>
