<!DOCTYPE html>
<html>
<head>
  <title>RL Car Simulation</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    label { display: block; margin-top: 10px; }
    output { margin-left: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Car Simulator</h2>

  <label>Friction: 
    <input type="range" id="friction" min="0" max="1.0" step="0.01" value="0.7" oninput="fDisplay.value = friction.value">
    <output id="fDisplay">0.7</output>
  </label>

  <label>Gas Sensitivity:
    <input type="range" id="gas_sensitivity" min="0" max="2.0" step="0.01" value="0.9" oninput="gDisplay.value = gas_sensitivity.value">
    <output id="gDisplay">0.9</output>
  </label>

  <label>Brake Sensitivity:
    <input type="range" id="brake_sensitivity" min="0" max="2.0" step="0.01" value="0.4" oninput="bDisplay.value = brake_sensitivity.value">
    <output id="bDisplay">0.4</output>
  </label>

  <label>Steer Sensitivity:
    <input type="range" id="steer_sensitivity" min="0" max="0.5" step="0.01" value="0.1" oninput="sDisplay.value = steer_sensitivity.value">
    <output id="sDisplay">0.1</output>
  </label>

  <label>Path Type:
    <select id="path_type">
      <option value="sine">Sine</option>
      <option value="straight">Straight</option>
    </select>
  </label>

  <button onclick="simulate()">Simulate</button>
  <button id="resetBtn">Reset to Defaults</button>

  <div id="plot" style="width: 700px; height: 450px; margin-top: 20px;"></div>

  <script>
    let animationInterval = null; // keep track of ongoing animation
  
    async function simulate() {
      // Cancel any ongoing animation
      if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
      }
  
      // Fetch params
      const friction = parseFloat(document.getElementById("friction").value);
      const gas_sensitivity = parseFloat(document.getElementById("gas_sensitivity").value);
      const brake_sensitivity = parseFloat(document.getElementById("brake_sensitivity").value);
      const steer_sensitivity = parseFloat(document.getElementById("steer_sensitivity").value);
      const path_type = document.getElementById("path_type").value;
  
      // Call backend
      const res = await fetch("/simulate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          friction,
          gas_sensitivity,
          brake_sensitivity,
          steer_sensitivity,
          path_type
        })
      });
      const data = await res.json();
      const path = data.path;
      const car = data.car;
  
      // Initialize empty traces to start with
      const plotData = [
        {
          x: [], y: [],
          mode: 'lines',
          name: 'Path',
          line: { dash: 'dot', width: 2, color: 'gray' }
        },
        {
          x: [], y: [],
          mode: 'lines+markers',
          name: 'Car',
          line: { color: 'blue' },
          marker: { size: 6 }
        }
      ];
  
      Plotly.newPlot('plot', plotData, {
        margin: { t: 20, b: 40, l: 40, r: 20 },
        xaxis: { title: "X" },
        yaxis: { title: "Y", scaleanchor: "x" }
      });
  
      let idx = 0;
      const maxIdx = Math.max(path.length, car.length);
  
      animationInterval = setInterval(() => {
        if (idx >= maxIdx) {
          clearInterval(animationInterval);
          animationInterval = null;
          return;
        }
  
        // Append next point for path (if available)
        if (idx < path.length) {
          Plotly.extendTraces('plot', {
            x: [[path[idx][0]]],
            y: [[path[idx][1]]]
          }, [0]);
        }
  
        // Append next point for car (if available)
        if (idx < car.length) {
          Plotly.extendTraces('plot', {
            x: [[car[idx][0]]],
            y: [[car[idx][1]]]
          }, [1]);
        }
  
        idx++;
      }, 50); // update every 50 ms, adjust speed here
      document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("friction").value = 0.7;
      document.getElementById("fDisplay").value = 0.7;

      document.getElementById("gas_sensitivity").value = 0.9;
      document.getElementById("gDisplay").value = 0.9;

      document.getElementById("brake_sensitivity").value = 0.4;
      document.getElementById("bDisplay").value = 0.4;

      document.getElementById("steer_sensitivity").value = 0.1;
      document.getElementById("sDisplay").value = 0.1;

      document.getElementById("path_type").value = "sine";
    });
    }
  </script>  
</body>
</html>
